# レシピ変換プラットフォーム 機能仕様書

## 1. 目的
SNS等から収集したレシピテキストを自動的に取り込み、高血圧かつ糖尿病予備群向けの栄養方針に従って調整したレシピ・画像プロンプト・生成画像・静的サイト用ページを生成し、GitHub Pagesで公開できるようにするワークフローを設計する。

## 2. スコープ
- **対象**: プレーンテキスト入力の取り込み、LLMを用いたテキスト→構造化データ変換、別インスタンスLLMによるレシピ変換、さらに別インスタンスLLMによる変換結果の検証、栄養バリデーション、成果物生成（JSON・Markdown・画像プロンプト・生成画像）、静的サイト公開、失敗時のレポート。
- **対象外**: 医師等による手動レビュー、個別の栄養指導、GitHub標準以外の認証/認可、GitHub Pages以外での画像ホスティング。

## 3. ステークホルダーとアクター
- **レシピキュレーター（ユーザー）**: オリジナルレシピのテキストをコミット/PRし、CIからのフィードバックを確認する。
- **抽出LLM（Parse LLM）**: Claude Code SDK等を用い、プレーンテキストから材料・分量・手順を抽出して中間JSONを生成する役割。
- **変換LLM（Transform LLM）**: 抽出結果とコンテキストパック、ルールセットを使い、栄養方針に適合したレシピへ再構成する役割。
- **検証LLM（Verify LLM）**: 元レシピ材料と変換後材料を突合し、置換ルールや栄養制約が守られているかを確認する役割。
- **検証スクリプト**: LLMの検証結果と栄養データを突き合わせ、最終判定を行うプログラム。
- **変換パイプライン**: CI上で各LLM呼び出し、検証、公開処理を統括。
- **画像生成サービス**: 画像生成APIを呼び出し仕上がりイメージを生成する外部サービス。
- **サイト訪問者**: GitHub Pagesで公開されたレシピを閲覧する一般ユーザー。

## 4. ハイレベルワークフロー
1. **テキスト取り込み**: ユーザーが`recipes/src/raw/`へプレーンテキスト（材料・手順を含む）を追加。
2. **LLM抽出**: 抽出LLMがテキストを中間JSONへ変換（材料・分量・手順・カテゴリ）。
3. **レシピ変換**: 変換LLMが中間JSONとコンテキストパックを元に、ターゲット向けレシピJSONを生成。
4. **LLM検証**: 検証LLMが「元の材料」と「変換後の材料・手順」を比較し、置換ルール遵守・材料漏れ/過剰追加・栄養閾値への準備状況を自然言語で評価。
5. **プログラム検証**: 栄養推定、スキーマ整合性、チェックリスト判定を行い、LLM検証結果と突き合わせて問題があれば後続処理を停止。
6. **成果物生成**: 変換済みJSON、Markdown、画像プロンプト、生成画像、メタデータを出力。
7. **公開**: 静的サイトジェネレーターでビルドし、GitHub Pagesへデプロイ。
8. **レポート**: PRコメントやworkflow summaryで変換結果、検証ステータス、成果物リンクを通知。

## 5. 機能要件
### 5.1 テキスト取り込みとLLM抽出
- 入力フォルダ: `recipes/src/raw/`。UTF-8テキストで材料・手順を含む。
- 抽出LLMには以下を提供:
  - サンプルフォーマットと期待する中間JSONスキーマ。
  - 材料・分量抽出時のガイドライン（記号、全角/半角、数量推定規則）。
- 抽出結果は`recipes/src/original/<slug>.json`として保存。
- 抽出LLMの回答が欠損/不整合な場合は再試行し、それでも失敗すればCIを失敗とする。
- 抽出LLMプロンプトとレスポンスは`artifacts/llm_logs/parse/`に記録。

### 5.2 レシピ変換サービス（変換LLM）
- 変換LLMには以下を入力:
  - コンテキストパック（`prompts/context_pack.md`）。
  - 栄養・調味料変換ルール（`data/rules/*.json`）。
  - 抽出結果の中間JSON。
  - 期待する出力スキーマ説明と実例。
- レスポンスは正規化スクリプトでスキーマ整形し、`recipes/out/converted/<slug>.json`へ保存。
- 変換LLMプロンプトとレスポンスを`artifacts/llm_logs/transform/`に記録。

### 5.3 LLM検証サービス（検証LLM）
- 入力:
  - 元テキストの材料・手順（抽出JSONから再構成）。
  - 変換後レシピJSON。
  - 検証用チェックリスト（栄養閾値・置換ルール・材料欠落チェック等）。
- 出力:
  - 各チェック項目に対する評価（`pass`/`fail`/`warn`）と説明。
  - 材料突合表（元→変換後）。
- 検証LLMの結果は`verify_report.json`として保存し、プログラム検証と統合。
- 検証LLMログは`artifacts/llm_logs/verify/`に保存。

### 5.4 栄養推定とプログラム検証
- 栄養データベース（`data/nutrition.csv`）を用いて塩分・糖質・たんぱく質・脂質を推定。
- 閾値遵守: 主菜塩分≤1.2g（汁物≤1.0g）、主菜糖質≤15g（主食代替40–60g）、たんぱく質≥25g、飽和脂肪抑制。
- LLM検証で`fail`が出た項目はプログラム検証でも必ずチェックし、両方の結果を`checklist`に反映。
- 逸脱時は自動調整（再プロンプト/補正）を試み、最終的に解決不可ならCI失敗。

### 5.5 成果物生成
- Markdownテンプレートに値を差し込み、`site/content/recipes/`に保存。
- プロンプトは`assets/prompts/<slug>.txt`、画像は`assets/img/<slug>.webp`。
- LLM検証レポートを含む監査レポートを`artifacts/reports/<slug>.md`にまとめる。

### 5.6 画像生成
- 変換LLMが生成した画像プロンプトを使用。
- 画像生成API呼び出しと結果保存は従来の仕様通り。

### 5.7 GitHub Actionsワークフロー統合
- `.github/workflows/convert-and-publish.yml`で以下を実装:
  1. **parse** ジョブ: 抽出LLM呼び出し→中間JSON生成。
  2. **transform** ジョブ: 変換LLM呼び出し→変換JSON生成。
  3. **verify** ジョブ: 検証LLM呼び出し→検証レポート生成→プログラム検証。
  4. **build-site** ジョブ: Markdown生成・SSGビルド。
  5. **deploy** ジョブ: GitHub Pagesデプロイ。
- 各LLMジョブは`ANTHROPIC_API_KEY`や`CLAUDE_CODE_OAUTH_TOKEN`など個別Secretsを参照。Rate limit対応として再試行バックオフを実装。
- 例示ワークフローと同様に、`claude-code` CLIセットアップや環境変数設定、成果物コミットを含む。

### 5.8 レポーティングと可観測性
- PRコメントおよびworkflow summaryでLLM検証結果と栄養チェック結果を併記。
- LLMログは必要に応じてマスクしつつアーティファクト保管。
- 各LLM呼び出しにtrace IDを付与し、障害解析を容易にする。

## 6. データ構造
（前節と同一。LLM検証レポートを追加）

### 6.5 検証レポート (`artifacts/verify/<slug>.json`)
```
{
  "materials_check": [{"original": string, "converted": [string], "status": "pass"|"warn"|"fail", "notes": string}],
  "rule_checks": [{"rule": string, "status": "pass"|"warn"|"fail", "llm_comment": string}],
  "suggested_actions": [string]
}
```

## 7. 非機能要件
- **決定性**: LLM呼び出しは温度や乱数を固定（`temperature=0`等）。再プロンプトを行う場合もログ化して追跡可能にする。
- **拡張性**: 抽出LLM・変換LLM・検証LLMのプロンプト/ルールを個別ファイルで管理し、他の食事制限ルールへの拡張に備える。
- **保守性**: `scripts/parse_with_llm.js`, `scripts/transform_with_llm.js`, `scripts/verify_with_llm.js`など役割ごとに分割。
- **性能**: 最大20件のレシピ処理でも各LLMのシリアル呼び出しがCI制限内で完了。必要に応じてバッチ化。
- **セキュリティ**: LLMログや原文テキストに個人情報が含まれる場合はマスク。SecretsはGitHub Actions Secretsで管理。

## 8. 未確定事項
1. LLM抽出の再試行戦略（最大リトライ数、バックオフ設定）。
2. 検証LLMの閾値（warnとfailの線引き）と最終判定の優先順位。
3. 栄養データソースのライセンスと形式。
4. 採用する静的サイトジェネレーターとテーマ要件。
5. 多言語対応（現状は日本語テンプレート。英語併記は必要か）。

## 9. 将来拡張案
- 元レシピと変換後レシピの栄養差分レポート自動生成。
- レシピカテゴリに応じた自動タグ付け、フィルタリング機能。
- 新しい食事制限向けルールセット（例: 腎臓病向け）への展開。

