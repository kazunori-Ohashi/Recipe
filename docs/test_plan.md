# レシピ変換プラットフォーム テスト計画書

## 1. テスト目的
- プレーンテキスト入力から複数LLM（抽出/変換/検証）を組み合わせたレシピ変換が正しく行われ、高血圧かつ糖尿病予備群向け栄養制約を満たすことを検証する。
- テキスト解析、自然言語出力整形、栄養計算、成果物生成、外部API連携、LLM検証結果の判定に関する回帰を自動検出できるようにする。
- GitHub Actionsワークフローのトリガー条件やSecrets使用手順が仕様通りに動作することを確認する。

## 2. テスト戦略
| レベル | 担当 | 目的 | ツール |
|--------|------|------|--------|
| 単体 | スクリプト開発者 | LLMプロンプト生成、レスポンス整形、栄養推定、スラッグ生成等の関数を検証 | pytest / vitest + フィクスチャ |
| 結合 | パイプライン管理者 | 抽出LLM→変換LLM→検証LLM→栄養検証の一連処理を確認 | CLIスクリプト（make/npm）、LLMモッククライアント |
| ワークフロー | DevOps | GitHub Actionsワークフローの分岐・Secrets・Claude SDK統合を検証 | act（ローカル） / GitHub Actions テストworkflow |
| E2E | DevOps | 解析〜公開までの全体フローを再現 | act（ローカル） / GitHub Actions |
| 回帰 | 自動化 | 代表レシピの出力スナップショットでドリフト検出 | スナップショットテスト |

## 3. 環境とデータ
- **ローカル**: Python/Nodeランタイム。Claude SDKはモック/スタブ使用。画像生成APIもモック可能。
- **CI**: GitHub Actionsランナー（`ubuntu-latest`）。栄養データセットとルールファイルはリポジトリ内にバージョン管理し決定性を確保。
- **テストフィクスチャ**:
  - `fixtures/raw/*.txt`: パターン別の入力テキスト。
  - `fixtures/original/*.json`: 抽出LLM期待結果。
  - `fixtures/claude_prompts/{parse,transform,verify}/*.txt`: 各LLMへのプロンプトテンプレート。
  - `fixtures/claude_responses/{parse,transform,verify}/*.json`: 各LLMのモックレスポンス。
  - `fixtures/nutrition.csv`: 再現性の高い栄養データ。
  - `fixtures/workflow_events/*.json`: ワークフローテスト用イベントペイロード。

## 4. テストケース
### 4.1 単体テスト
1. **抽出LLMプロンプト生成**
   - 入力: テキストファイルのサンプル。
   - 期待値: プロンプトが仕様で定義したセクション（材料・手順・出力フォーマット）を含む。
2. **抽出LLMレスポンス整形**
   - 入力: 省略/表記揺れを含むモックレスポンス。
   - 期待値: 中間JSONに正規化され、欠損時はエラーが発生。
3. **変換LLMレスポンス整形**
   - 入力: 栄養指標欠落のレスポンス。
   - 期待値: 不備を検知し再プロンプト要求を返す。
4. **検証LLM結果統合**
   - 入力: `fail`項目を含む検証LLMレスポンス。
   - 期待値: プログラム検証チェックリストへ反映され、CIが失敗する。
5. **マクロ推定関数**
   - 入力: 栄養テーブルに存在する食材。
   - 期待値: サービング数を考慮したマクロ合計が算出される。
6. **スラッグ生成**
   - 入力: 日本語タイトルを含む中間JSON。
   - 期待値: ASCIIのみのスラッグが出力される。

### 4.2 結合テスト
1. **抽出LLMモック正常系**
   - `scripts/parse_with_llm --mock fixtures/raw/main_karaage.txt`
   - 検証: 出力JSONが期待スナップショットと一致。
2. **変換LLMモック正常系**
   - 中間JSONとモックレスポンスを使用。
   - 検証: 変換JSONがスキーマ準拠、栄養閾値内。
3. **検証LLMモック正常系**
   - 入力: 元・変換材料セット。
   - 検証: `verify_report.json`に材料突合とルール判定が記録。
4. **検証LLMモック異常系**
   - 入力: 材料漏れのレスポンス。
   - 検証: プログラム検証がCI失敗を返す。
5. **Markdownビルダー**
   - 入力: 完成JSON。
   - 検証: Markdownスナップショット一致。
6. **画像生成モック**
   - 入力: プロンプトファイル。
   - 検証: 画像とメタデータ作成。

### 4.3 ワークフローテスト
1. **イベントトリガーチェック**
   - `act`で`workflow_dispatch`またはPRイベントを模擬。
   - 検証: `run_next`フラグが正しく設定され、LLMステップが実行される。
2. **LLMステップチェーン**
   - `act`実行で抽出→変換→検証の各ステップが順に成功。
3. **Secrets利用検証**
   - ダミーSecretsを設定し、`CLAUDE_CODE_OAUTH_TOKEN`等が読み込まれることを確認。
4. **成果物コミット動作**
   - 差分がある場合のみコミット、差分なしは`No changes to commit`で終了。
5. **LLM失敗時のフォールバック**
   - モックレスポンスで`fail`を返し、ワークフローが正しく停止すること。

### 4.4 E2Eテスト
1. **フルパイプラインドライラン**
   - `act`で全ジョブ（parse→transform→verify→build-site→deploy(モック)）を実行。
   - 検証: サイトアーティファクト生成、チェックリスト全pass。
2. **栄養閾値違反シナリオ**
   - 糖質過多なフィクスチャを投入。
   - 検証: 検証LLMとプログラム検証双方が`fail`を出し、ジョブが失敗。
3. **変換ルール逸脱シナリオ**
   - 変換LLMモックが置換を行わないレスポンスを返す。
   - 検証: 検証LLMが`fail`し、CIがブロック。
4. **Claude APIキー欠如シナリオ**
   - Secrets未設定で実行。
   - 検証: `transform`ジョブで失敗し、再設定案内を出力。
5. **画像APIキー欠如シナリオ**
   - `IMAGE_API_KEY`なし。
   - 検証: 画像ステップを警告付きでスキップし、レシピ/Markdownは生成。

### 4.5 回帰・スナップショットテスト
- `snapshots/converted/*.json`、`snapshots/markdown/*.md`、`snapshots/claude_prompts/{parse,transform,verify}/*.txt`、`snapshots/verify_reports/*.json`で代表レシピを固定。
- `snapshots/workflow_logs/*.txt`でワークフロー主要ログを保持し、セットアップ手順の変化を監視。
- スナップショット更新時はルール遵守を確認するレビュー手順を実施。

## 5. テストデータ管理
- フィクスチャは匿名化。個人情報や著作権保護テキストを避ける。
- 栄養データセットにチェックサムを付与し、テスト開始時に検証。
- LLMモックレスポンスは`converter_version`ごとに更新履歴を管理。
- Secretsが必要なテストはモックトークンを利用し、実シークレットを含めない。
- スナップショット変更はPull Requestで承認を得て更新。

## 6. 開始/終了条件
- **単体**: 重要ロジックの分岐網羅率80%以上。クリティカル欠陥なし。
- **結合**: 抽出→変換→検証の主要シナリオが通過。重大バグなし。
- **ワークフロー**: トリガー判定、LLMチェーン、成果物コミットの各ステップが`act`で成功。
- **E2E**: ドライラン成功、失敗シナリオで期待通りワークフローが停止。

## 7. ツールとコマンド
- `make test-unit`: pytest/vitestで単体テスト。
- `make test-int`: 結合テスト（LLMモック含む）。
- `make test-workflow`: `act`を用いたワークフローテスト。
- `make test-e2e`: `act`または検証用GitHubワークフローを実行。
- `make lint`: JSON/Markdown整形、スキーマ検証、プロンプト差分チェック。

## 8. レポート
- CIでカバレッジレポートを公開し、変換済み成果物とLLMログをアーティファクトとして添付。
- 失敗時は栄養指標・検証ログ・LLM呼び出しID・ワークフローログへのリンクを提示。

## 9. 保守
- 栄養ガイドラインやルールファイルが更新された場合、四半期ごとにテストケースを見直す。
- 新しい常備食材や置換ルール、LLMプロンプトを追加した際はフィクスチャとモックレスポンスを更新。
- テスト基準やSecrets取り扱いルールを変更した場合、`docs/CHANGELOG.md`で背景を記録。

